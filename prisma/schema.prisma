// Prisma Schema for Schedule Bot
// PostgreSQL Database

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Main schedule table - replaces Sheet1
model Schedule {
  id        Int              @id @default(autoincrement())
  date      String           @unique // Format: DD.MM.YYYY
  reason    String           @default("")
  focus     String           @default("")
  players   SchedulePlayer[]
  createdAt DateTime         @default(now()) @map("created_at")
  updatedAt DateTime         @updatedAt @map("updated_at")

  @@index([date])
  @@map("schedules")
}

// Dynamic player entries for each schedule
model SchedulePlayer {
  id           Int      @id @default(autoincrement())
  scheduleId   Int      @map("schedule_id")
  schedule     Schedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  userId       String   @map("user_id") // Discord ID
  displayName  String   @map("display_name") // Custom name for Discord
  role         UserRole
  availability String   @default("") // "14:00-20:00", "x", ""
  sortOrder    Int      @default(0) @map("sort_order") // Order in Discord message
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@index([scheduleId])
  @@index([userId])
  @@map("schedule_players")
}

// User mapping table - replaces UserMapping sheet
model UserMapping {
  id              Int      @id @default(autoincrement())
  discordId       String   @unique @map("discord_id")
  discordUsername String   @map("discord_username")
  displayName     String   @map("display_name") // Custom name for Discord messages
  role            UserRole
  sortOrder       Int      @default(0) @map("sort_order") // Order in lists
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@index([discordId])
  @@index([role, sortOrder])
  @@map("user_mappings")
}

enum UserRole {
  MAIN
  SUB
  COACH
}

// Absences table - replaces Absences sheet
model Absence {
  id        String   @id // Format: abs_timestamp_random
  userId    String   @map("discord_id")
  username  String
  startDate String   @map("start_date") // Format: DD.MM.YYYY
  endDate   String   @map("end_date") // Format: DD.MM.YYYY
  reason    String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([userId])
  @@index([startDate])
  @@index([endDate])
  @@map("absences")
}

// Scrims/Matches table - replaces Matches sheet
model Scrim {
  id          String      @id // Format: scrim_timestamp_random
  date        String      // Format: DD.MM.YYYY
  opponent    String
  result      ScrimResult
  scoreUs     Int         @default(0) @map("score_us")
  scoreThem   Int         @default(0) @map("score_them")
  map         String      @default("")
  matchType   String      @default("") @map("match_type")
  ourAgents   String      @default("") @map("our_agents") // Comma-separated
  theirAgents String      @default("") @map("their_agents") // Comma-separated
  vodUrl      String      @default("") @map("vod_url")
  notes       String      @default("")
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  @@index([date])
  @@map("scrims")
}

enum ScrimResult {
  WIN
  LOSS
  DRAW
}

// Settings table - replaces Settings sheet
model Setting {
  id        Int      @id @default(autoincrement())
  key       String   @unique
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("settings")
}
